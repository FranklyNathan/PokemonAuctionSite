<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auction Setup</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/themes/light.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/themes/dark.css" />
    <link rel="stylesheet" href="/style.css" />
    <style>
      .sl-theme-dark sl-button[variant='neutral']::part(label) {
        color: white;
      }

      .control-button {
        --sl-spacing-x-small: 0; /* remove horizontal padding */
      }

      .control-button::part(base) {
        width: 3rem;
        height: 1rem;
        justify-content: center;
      }
    </style>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/button/button.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/input/input.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/dialog/dialog.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/switch/switch.js"></script>
  </head>

  <body style="padding: 1rem">
    <div style="display: flex; width: 100%; justify-content: center">
      <h1 style="background-color: var(--container-bg-color); padding: 0.5rem 1rem; border: 1px solid black">Auction Setup</h1>
    </div>
    <sl-dialog id="welcome-dialog" open>
      <div slot="label" style="display: flex; align-items: center; gap: 1rem">
        Welcome!
        <img src="/images/Froakie.png" alt="Froakie" style="height: 2.5rem" />
      </div>
      <p>This is an auction style draft app for Pokemon Emerald speedruns.</p>
      <p>First, click Use Default CSV.</p>
      <p>Then, click Resouce Mode to browse the pool or Create Auction to draft.</p>
      <p>Alternatively, click Boss Battles view all enemy lineups</p>
      <sl-button id="custom-auction" slot="footer" variant="primary">Got it!</sl-button>
    </sl-dialog>
    <form
      id="form"
      method="post"
      action="new-auction"
      enctype="multipart/form-data"
      style="display: flex; flex-direction: column; align-items: center; padding-bottom: 2rem"
    >
      <input id="resourceMode" name="resourceMode" type="hidden" value="false" />
      <input id="useDefaultCsv" name="useDefaultCsv" type="hidden" value="false" />
      <div
        style="
          background-color: var(--container-bg-color);
          border-radius: 0;
          border: 1px solid black;
          padding: 1rem;
          min-width: 10rem;
          max-width: 60rem;
          margin-bottom: 2rem;
        "
      >
        <div style="display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between">
          <sl-input
            id="numTeams"
            name="numTeams"
            label="Number of Teams"
            type="number"
            value="2"
            min="2"
            max="100"
            step="1"
            required
            inputmode="decimal"
            pattern="[0-9]+"
            style="padding: 1rem; min-width: 15rem"
            class="label-no-move-input"
            size="small"
          ></sl-input>
          <div style="display: flex; flex-wrap: wrap; align-items: center">
            <sl-input
              id="defaultFunds"
              name="defaultFunds"
              label="Default Funds"
              type="number"
              value="20000"
              min="0"
              max="1000000"
              step="1"
              required
              inputmode="decimal"
              pattern="[0-9]+"
              style="padding: 1rem"
              class="label-no-move-input"
              size="small"
            ></sl-input>
            <sl-button id="updateDefaultFunds" size="small"> Set All to Default</sl-button>
          </div>
        </div>
        <div id="teamNames" style="margin-bottom: 3rem"></div>
        <div style="display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 3rem">
          <sl-input
            id="biddingTimeLimit"
            name="biddingTimeLimit"
            label="Bidding Time Limit (seconds)"
            type="number"
            value="10"
            min="5"
            max="60"
            step="1"
            required
            inputmode="decimal"
            pattern="[0-9]+"
            style="padding: 1rem; max-width: 20rem"
            class="label-no-move-input"
            size="small"
          ></sl-input>
          <sl-input
            id="totalPokemonAuctioned"
            name="totalPokemonAuctioned"
            label="Total PokÃ©mon Auctioned"
            type="number"
            value="60"
            min="1"
            max="500"
            step="1"
            required
            inputmode="decimal"
            pattern="[0-9]+"
            style="padding: 1rem; max-width: 20rem"
            class="label-no-move-input"
            size="small"
          ></sl-input>
          <div style="padding: 1rem;">
            <sl-switch name="flashbangsEnabled">Flashbangs</sl-switch>
          </div>
        </div>
      </div>

      <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem">
        <input
          id="csvInput"
          name="csvInput"
          type="file"
          accept=".csv"
          required
          style="opacity: 0; height: 0; max-height: 0; margin-bottom: -1rem"
        />
        <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem">
          <div style="display: flex; gap: 1rem">
            <sl-button id="csvSelect" size="small" title="Upload players as a CSV file with columns: 'name' and 'type'">
              Upload Custom CSV
            </sl-button>
            <sl-button id="defaultCsvButton" size="small"> Use Default CSV </sl-button>
          </div>
          <sl-button type="submit" id="formSubmit" style="width: 100%"> Create Auction! </sl-button>
        </div>
        <div id="csvFileName" style="height: 1rem"></div>
      </div>

      <div style="display: flex; gap: 1rem; align-items: center; margin-top: 3rem;">
        <sl-button onclick="window.location.href='/assets/boss-battles.html'" style="width: 10rem"> Boss Battles </sl-button>
        <sl-button id="resourceModeButton" style="width: 10rem"> Resource Mode </sl-button>
      </div>
    </form>

    <sl-button id="dark-mode-toggle" class="control-button" variant="neutral" style="position: fixed; bottom: 1rem; right: 1rem;"></sl-button>
  </body>

  <script type="module">
    // stop the "flash-of-undefined-components" by waiting until all components are registered.
    await Promise.allSettled([customElements.whenDefined('sl-button'), customElements.whenDefined('sl-input')]);
    // Add the `ready` class so the UI fades in.

    // --- Dark Mode Logic ---
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const htmlEl = document.documentElement;

    function applyTheme(theme) {
      if (theme === 'dark') {
        htmlEl.classList.add('sl-theme-dark');
        darkModeToggle.innerHTML = '<img src="/MiniIcons/solrock.png" alt="Light Mode" style="height: 1.4rem; position: relative; top: 6px;">';
      } else {
        htmlEl.classList.remove('sl-theme-dark');
        darkModeToggle.innerHTML = '<img src="/MiniIcons/lunatone.png" alt="Dark Mode" style="height: 1.4rem; position: relative; top: 6px;">';
      }
    }

    // Check for saved theme in localStorage on page load and apply it.
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);

    darkModeToggle.addEventListener('click', () => {
      const newTheme = htmlEl.classList.contains('sl-theme-dark') ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      applyTheme(newTheme);
    });
    // --- End Dark Mode Logic ---

    document.body.classList.add('ready');

    document.getElementById('custom-auction').addEventListener('click', (e) => {
      document.getElementById('welcome-dialog')?.hide();
    });

    const numTeamsEl = document.getElementById('numTeams');
    const defaultFundsEl = document.getElementById('defaultFunds');
    const updateDefaultFundsEl = document.getElementById('updateDefaultFunds');
    const teamNamesContainer = document.getElementById('teamNames');
    const formEl = document.getElementById('form');

    function teamNameFundsHTML(n) {
      return `
        <div id="team${n}Config" style="display: flex; flex-wrap: wrap; align-content: center; gap: 0.5rem; padding-top: 0.5rem">
          <div style="flex: 6; display: flex; font-weight: bold; align-items: center; justify-content: center;">${n + 1}</div>
          <sl-input name="team${n}Name" class="requiredConfig" placeholder="Team ${n + 1} Name" style="flex: 74;" pattern="[a-zA-Z0-9']+" title="Name must not use any special characters!" maxlength="50" autocomplete="off"></sl-input>
          <sl-input name="team${n}Funds" class="requiredConfig default-funds" placeholder="Available Funds" type="number" min="0" max="1000000" step="1" title="Integer value" inputmode="decimal" style="flex: 20;" autocomplete="off" value="${defaultFundsEl.value}"></sl-input>
        </div>`;
    }

    let numTeams = 0; // initial number of teams
    function updateTeamNameInputs(newNumTeams) {
      // adds or removes team configurations, keeping existing team config HTML untouched
      //   to prevent data loss
      const diff = newNumTeams - numTeams;
      if (diff > 0) {
        // add more team configs
        for (let i = numTeams; i < newNumTeams; i++) {
          // insert the new HTML to the DOM.
          teamNamesContainer.insertAdjacentHTML('beforeend', teamNameFundsHTML(i));
        }
      } else {
        // remove team configs
        for (let i = numTeams - 1; i >= newNumTeams; i--) {
          document.getElementById(`team${i}Config`)?.remove();
        }
      }
      numTeams = newNumTeams; // update the stored value
    }

    updateTeamNameInputs(2); // create the initial inputs for the teams

    // add the correct number of team detail sections when the numTeams input value changes
    numTeamsEl.addEventListener('sl-change', (event) => {
      numTeamsEl.reportValidity();
      if (numTeamsEl.checkValidity()) {
        // convert string to number!
        updateTeamNameInputs(+numTeamsEl.value);
      }
    });

    // update all teams with the default funds when button is clicked
    updateDefaultFundsEl.addEventListener('click', () => {
      if (defaultFundsEl.checkValidity()) {
        document.querySelectorAll('sl-input.default-funds').forEach((el) => (el.value = defaultFundsEl.value));
      }
    });

    /////////////////////////
    // custom form validation
    // dynamically adding/removing inputs screws with the built in validation
    /////////////////////////
    formEl.addEventListener('submit', (event) => {
      // Prevent the default form submission initially
      event.preventDefault();

      if (document.getElementById('resourceMode').value === 'true') {
        formEl.submit();
        return;
      }

      let valid = true;
      for (const input of document.querySelectorAll('.requiredConfig')) {
        if (!input.checkValidity() || input.value == '') {
          input.focus();
          input.reportValidity();
          valid = false;
          break;
        }
      }

      if (valid) {
        // continue with regular validation
        formEl.submit();
      }
    });

    //////////////////
    // CSV input stuff
    //////////////////

    // wire up the more stylish button to click the hidden file input
    const csvSelectEl = document.getElementById('csvSelect');
    const csvInputEl = document.getElementById('csvInput');
    const csvFileNameEl = document.getElementById('csvFileName');
    const defaultCsvButtonEl = document.getElementById('defaultCsvButton');
    const useDefaultCsvEl = document.getElementById('useDefaultCsv');
    const resourceModeButtonEl = document.getElementById('resourceModeButton');
    const resourceModeEl = document.getElementById('resourceMode');

    resourceModeButtonEl.addEventListener('click', () => {
      resourceModeEl.value = 'true';
      useDefaultCsvEl.value = 'true'; // Resource mode always uses the default CSV
      // Bypasses validation via the submit handler
      formEl.requestSubmit();
    });
    
    defaultCsvButtonEl.addEventListener('click', () => {
      csvInputEl.removeAttribute('required');
      csvInputEl.value = ''; // Clear any selected file
      csvFileNameEl.innerHTML = 'ð Pok.csv (Default)';
      useDefaultCsvEl.value = 'true';
    });

    csvSelectEl.addEventListener(
      'click',
      () => {
        if (csvInputEl) csvInputEl.click();
      },
      false,
    );
    // show the uploaded file name
    csvInputEl.addEventListener('change', () => {
      if (csvInputEl.files && csvInputEl.files.length > 0) {
        csvFileNameEl.innerHTML = 'ð ' + csvInputEl.files[0].name;
        csvInputEl.setAttribute('required', ''); // re-add required if user selects a file
        useDefaultCsvEl.value = 'false';
      } else {
        csvFileNameEl.innerHTML = '';
      }
    });
  </script>
</html>
