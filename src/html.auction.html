<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auction</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/themes/light.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/themes/dark.css" />
    <link rel="stylesheet" href="/style.css" />
    <!-- shoelace components -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/alert/alert.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/tooltip/tooltip.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/radio/radio.js"></script>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/icon-button/icon-button.js"
    ></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/dropdown/dropdown.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/menu/menu.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/menu-item/menu-item.js"></script>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/radio-group/radio-group.js"
    ></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/button/button.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/card/card.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/animation/animation.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/input/input.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/dialog/dialog.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/badge/badge.js"></script>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/progress-bar/progress-bar.js"
    ></script>
    <script src="vendor/ag-grid.js"></script>
    <script src="vendor/confetti.js"></script>
    <script src="vendor/papaparse.js"></script>
  </head>

  <style>
    #player::part(body) {
      display: none;
    }
  </style>

  <body>
    <div style="display: flex; flex-direction: column; height: 100%; padding: 1rem; overflow-x: auto; overflow-y: hidden">
      <!-- Top section with teams -->
      <div style="width: 100%; display: flex; background-color: var(--container-bg-color); border: 1px solid black; padding: 0.2rem">
        <div
          id="teamsSection"
          style="
            flex: 1;
            display: flex;
            justify-content: stretch;
            gap: 0.4rem;
            height: fit-content;
            min-height: fit-content;
            padding: 0.4rem;
            overflow-x: auto;
          "
        ></div>
      </div>
      <!-- center content container -->
      <div style="display: flex; justify-content: space-between; gap: 1rem; height: 100%; padding-top: 1rem">
        <!-- Left side section -->
        <div style="width: 75%; display: flex; flex-direction: column; gap: 1rem">
          <!-- Pokemon Info Section -->
          <div
            id="pokemon-info-section"
            style="height: 300px; background-color: var(--container-bg-color); border: 1px solid black; padding: 0.5rem; display: flex; justify-content: flex-start; align-items: stretch; gap: 0.05rem;"
          >
            <div id="species-info-text" style="display: none; flex: 0.6; text-align: left; overflow-y: auto; font-size: 0.9rem; margin: 0; padding-left: 2rem;"></div>
            <div id="pokemon-image-container" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 0.5rem;">
              <img id="pokemon-image" src="" alt="" style="display: none; max-height: 80%; max-width: 100%; object-fit: contain;" />
              <div id="pokemon-image-types" style="display: flex; gap: 0.2rem;"></div>
            </div>
            <div id="evolution-info-container" style="display: none; flex: 2; text-align: left; overflow: auto; font-size: 0.9rem; margin: 0; gap: 0.5rem; flex-direction: column;"></div>
          </div>
          <!-- Player list -->
          <div id="players-table-wrapper" style="height: 100%; width: 100%" class="ag-theme-balham"></div>
        </div>
        <!-- right side section with timer, current bid, player up for auction, etc -->
        <div style="flex: 1; display: flex; flex-direction: column; gap: 1rem; height: 100%">
          <div
            style="
              flex: 6;
              flex-shrink: 0;
              position: relative;
              background-color: var(--container-bg-color);
              border: 1px solid black;
              padding-top: 4rem;
              padding-bottom: 1rem;
              display: flex;
              flex-direction: column;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div style="position: absolute; top: 0; width: 100%; padding: 1rem">
              <sl-progress-bar id="time" value="0"></sl-progress-bar>
            </div>

            <div id="player-card-container" style="display: flex; flex-direction: column; align-items: center; width: 100%">
              <div id="waiting-msg" style="padding: 0 1rem; text-wrap: wrap; font-size: large; text-align: center"></div>
              <sl-card id="player" hidden class="player-card" style="width: 90%; max-width: 25rem; min-height: 5rem"></sl-card>
            </div>

            <span id="ready-up-container" hidden>
              <sl-button id="ready-up" size="large" style="width: 6rem">
                <sl-animation name="flash" easing="ease-in-out" duration="2000" play>
                  <strong>Ready Up!</strong>
                </sl-animation>
              </sl-button>
            </span>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.2rem; text-align: center;">
              <div id="highest-bidder" style="max-width: 15rem; overflow: hidden; font-size: 0.9rem; color: var(--sl-color-neutral-600);"></div>
              <sl-animation id="current-bid-animation" name="tada" easing="linear" duration="1000" iterations="1">
                <div id="current-bid" class="current-bid" style="font-size: xx-large"></div>
              </sl-animation>
            </div>
            <div style="width: 100%; padding-left: 0.5rem; padding-right: 0.5rem">
              <div
                style="
                  display: flex;
                  width: 100%;
                  justify-content: center;
                  gap: 2px;
                  border: 1px solid black;
                  border-radius: 0;
                  padding-top: 1rem;
                  padding-bottom: 1rem;
                  background-color: var(--container-bg-color);
                "
              >
                <sl-button id="raise1" disabled value="1" class="bet fixed-bet" style="width: 5.5rem"> ▲ $1 </sl-button>
                <sl-button id="raise5" disabled value="5" class="bet fixed-bet" style="width: 5.5rem"> ▲ $5 </sl-button>
                <sl-button id="raise10" disabled value="10" class="bet fixed-bet" style="width: 5.5rem"> ▲ $10 </sl-button>
              </div>
              <div style="display: flex; margin-top: 2rem; justify-content: center; gap: 1rem">
                <sl-input
                  id="raise-input"
                  type="number"
                  style="width: 7rem; box-shadow: var(--input-shadow-color) 0.15rem 0.15rem"
                  min="1"
                  step="1"
                  inputmode="decimal"
                ></sl-input>
                <sl-button id="raise" disabled class="bet"> Custom Bid </sl-button>
              </div>
            </div>
          </div>
          <div
            class="fade-bottom"
            style="
              position: relative;
              width: 100%;
              flex: 2;
              max-height: 10rem;
              overflow: hidden;
              border: 1px solid black;
              border-radius: 0;
              background-color: var(--container-bg-color);
            "
          >
            <div
              id="draft-log"
              style="
                display: flex;
                flex-direction: column;
                max-height: 5rem;
                padding: 0.4rem 0;
                gap: 0.5rem;
                width: 100%;
                font-family: 'Nimbus Mono PS', 'Courier New', monospace;
                line-height: 1em;
                overflow-y: scroll;
              "
            ></div>
          </div>
          <div style="display: flex; justify-content: flex-end; padding-top: 0.5rem; gap: 0.5rem">
            <sl-button id="dark-mode-toggle" variant="neutral" size="small" style="--sl-spacing-x-small: 0.25rem;"></sl-button>
            <sl-button id="pause-button" variant="neutral" size="small" style="min-width: 5rem">Pause</sl-button>
          </div>
          <!-- right side section -->
        </div>
      </div>
    </div>

    <sl-dialog id="teamSelectionDialog" label="Select Your Team" style="--width: 50vw">
      <div id="dialogContent" style="display: flex; gap: 1rem; flex-wrap: wrap"></div>
    </sl-dialog>

    <sl-dialog id="disconnectedDialog" label="Disconnected!">
      <div style="display: flex; justify-content: space-between">
        Reload the page to reconnect.
        <sl-button id="refreshButton" slot="footer" variant="primary">Reload</sl-button>
      </div>
    </sl-dialog>

    <sl-dialog id="noTeamsDialog" label="All Teams Connected!">
      <div style="display: flex; justify-content: space-between">
        All teams have already connected to this auction. If someone took your spot, call them and give them an earful.
        <sl-button id="refreshButton2" slot="footer" variant="primary">Reload</sl-button>
      </div>
    </sl-dialog>

    <div id="flashbang-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.95); color: white; justify-content: center; align-items: center; z-index: 9999; font-size: 2rem; text-align: center;"></div>

    <!--
      define some reusable templates
    -->
    <template id="participant-template">
      <style>
        :host(.high-bidder) #main-content {
          /* Use box-shadow to create a thicker border effect without affecting layout size */
          border-color: black;
          box-shadow: 0 0 0 2px black;
        }
        .ready {
          background-color: var(--sl-color-green-200);
        }
        .waiting {
          background-color: var(--sl-color-amber-200);
        }
        .disconnected {
          color: gray;
          background-color: var(--sl-color-rose-200);
        }
        .done {
          background-color: var(--sl-color-sky-200);
        }
        #main-content {
          border-bottom: 3px solid var(--sl-color-neutral-400);
          border: 1px solid black;
        }
        :host-context(.sl-theme-dark) #main-content {
          border-bottom-color: black;
        }
      </style>
      <div style="position: relative">
        <div id="top-left" style="position: absolute; left: 0.2rem; top: 0.2rem; cursor: default; display: flex; gap: 0.2rem; align-items: center;">
            <slot name="top-left-action"></slot>
        </div>
        <div id="top-right" style="position: absolute; right: 0.2rem; top: 0.2rem; cursor: default">
          <slot name="top-right"></slot>
        </div>
        <div style="position: absolute; bottom: 0.3rem; left: 0.2rem; font-size: smaller; font-weight: bold; color: gray; cursor: default">
          <slot name="lower-left-content">
            <sl-tooltip content="Disconnected" hoist style="--sl-tooltip-arrow-size: 0"> D </sl-tooltip>
          </slot>
        </div>
        <div style="position: absolute; bottom: 0.3rem; right: 0.2rem; font-size: smaller; color: gray; cursor: default">
          <sl-tooltip content="Roster Count" hoist style="--sl-tooltip-arrow-size: 0">
            <slot name="lower-right-content"></slot>
          </sl-tooltip>
        </div>
        <div
          id="main-content"
          class="disconnected"
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            min-width: 5rem;
            height: 4rem;
            border-radius: 0;
          "
        >
          <div><slot name="participant-name"></slot></div>
          <div><slot name="remaining-funds"></slot></div>
        </div>
      </div>
    </template>
  </body>

  <script type="module">
    const SECONDS = 1000;
    const ctx = {
      ws: null, // websocket
      // type Team = {
      //   clientId: number;
      //   teamName: string;
      //   remainingFunds: number;
      //   connected: boolean;
      //   ready: boolean;  // team has selected they are ready to start the auction
      //   rosterCount: number;
      // }
      // the actual teams map is injected into this HTML by the server, replacing the string replace target below
      teams: {}, // this is the target for a string replace server side
      allPlayersUnsorted: [], // A pristine, unsorted copy of all players for evolution lookups.
      playersTable: null,
      playersTableData: [],
      myClientId: undefined, // number
      stateId: 'pre_auction', // this is the target for a string replace server side
      isPaused: false,
      selectedPlayerId: null, // number
      currentBid: null, // number
      highestBidder: null, // number
      currentlySelectingTeam: null, // number
      timer: null, // CountDownTimer
      currentTimeLimit: null,
      biddingTimeLimit: null, // number
      playerSelectionTimeLimit: null, // number
      maxRosterSize: null, // number   // this is the target for a string replace server side
      extraPlayerStatsFields: [], // holds IDs of extra fields that were added to the players data
      // keep track of whether we have done the initial UI update when a player joins
      performedInitialUpdate: false,
    };

    ///////////
    // define the reusable web component templates from the above HTML
    ///////////
    customElements.define(
      'participant-el',
      class extends HTMLElement {
        constructor() {
          super();
          let participant = document.getElementById('participant-template');
          let myparticipant = participant.content;

          const shadowRoot = this.attachShadow({ mode: 'open' }).appendChild(myparticipant.cloneNode(true));
        }
      },
    );

    /**
     * Fetches and parses the speciesinfo.txt file.
     * The file is expected to have blocks of text for each Pokémon,
     * with the Pokémon's name on a line by itself.
     * @returns {Promise<Map<string, string>>} A map of Pokémon names to their info.
     */
    async function fetchAndParsePokemonInfo() {
      const speciesInfoMap = new Map(); // Will be Map<string, PokemonInfo>
      try {
        const response = await fetch('/api/speciesinfo');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        let text = await response.text();
        // Remove Byte Order Mark (BOM) if it exists, as it can interfere with parsing the first key.
        if (text.charCodeAt(0) === 0xfeff) {
          text = text.substring(1);
        }

        const lines = text.split(/\r\n?|\n/);
        let currentPokemonName = null;
        let currentInfo = {};
        let description = [];

        const saveCurrentPokemon = () => {
          if (currentPokemonName) {
            currentInfo.description = description.join('\n').trim();
            speciesInfoMap.set(currentPokemonName, currentInfo);
          }
        };

        for (const line of lines) {
          if (line.trim() === '') {
            saveCurrentPokemon();
            currentPokemonName = null;
            currentInfo = {};
            description = [];
            continue;
          }

          if (!currentPokemonName) {
            currentPokemonName = line.trim();
            continue;
          }

          const parts = line.split(':');
          if (parts.length > 1) {
            const key = parts[0].trim().toLowerCase();
            const value = parts.slice(1).join(':').trim();
            // All key:value pairs are now just part of the description.
            description.push(line);
          } else {
            description.push(line);
          }
        }
        saveCurrentPokemon(); // Save the last Pokémon in the file
      } catch (e) {
        console.error('Failed to load or parse speciesinfo.txt:', e);
      }
      return speciesInfoMap;
    }

    // module imports
    import { CountDownTimer } from '/clientModules/CountDownTimer.js';
    import { initTeamSelection } from '/clientModules/teamSelectionModal.js';
    import { setTimerTime, initBidButtonListeners, updateTeamCard, addMeIcon } from '/clientModules/html.js';
    import { loadPlayersData } from '/clientModules/playersTable.js';

    // --- Helper Functions ---
    const get = (id) => document.getElementById(id);
    
    // --- Dark Mode Logic ---
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const htmlEl = document.documentElement;

    function applyTheme(theme) {
      const tableWrapper = document.getElementById('players-table-wrapper');
      if (theme === 'dark') {
        htmlEl.classList.add('sl-theme-dark');
        if (tableWrapper) tableWrapper.classList.add('ag-theme-balham-dark');
        darkModeToggle.innerHTML = '<img src="/MiniIcons/solrock.png" alt="Light Mode" style="height: 1.2rem; vertical-align: middle;">';
      } else {
        htmlEl.classList.remove('sl-theme-dark');
        if (tableWrapper) tableWrapper.classList.remove('ag-theme-balham-dark');
        darkModeToggle.innerHTML = '<img src="/MiniIcons/lunatone.png" alt="Dark Mode" style="height: 1.2rem; vertical-align: middle;">';
      }
    }

    // Check for saved theme in localStorage on page load
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);

    // Add event listener to the toggle button
    darkModeToggle.addEventListener('click', () => {
      const newTheme = htmlEl.classList.contains('sl-theme-dark') ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      applyTheme(newTheme);
    });
    // --- End Dark Mode Logic ---

    ctx.timer = new CountDownTimer();
    // set the timer to update the UI on each "tick"
    ctx.timer.onTick((remaining, parsed, displayDuration) => {
      setTimerTime(
        `${String(parsed.minutes).padStart(2, '0')}:${String(parsed.seconds).padStart(2, '0')}`,
        remaining,
        displayDuration,
      );
    });

    // stop the "flash-of-undefined-components" by waiting until all components are registered.
    await Promise.allSettled([
      customElements.whenDefined('sl-button'),
      customElements.whenDefined('sl-dialog'),
      customElements.whenDefined('sl-radio'),
      customElements.whenDefined('sl-radio-group'),
      customElements.whenDefined('sl-progress-bar'),
    ]);

    // Add the `ready` class so the UI fades in.
    document.body.classList.add('ready');
    // team selection needs the sl-dialog component to be defined
    initTeamSelection(ctx);
    initBidButtonListeners(ctx);
    ctx.speciesInfoMap = await fetchAndParsePokemonInfo();
    await loadPlayersData(ctx);

    document.getElementById('refreshButton').addEventListener('click', (e) => location.reload());
    document.getElementById('refreshButton2').addEventListener('click', (e) => location.reload());

    // Pause button listener
    const pauseButton = document.getElementById('pause-button');
    pauseButton.addEventListener('click', () => {
      if (ctx.ws) {
        ctx.ws.send(JSON.stringify({ type: 'toggle_pause', stateId: ctx.stateId }));
      }
    });
  </script>
</html>
