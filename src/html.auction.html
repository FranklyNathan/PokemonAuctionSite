<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auction</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/themes/light.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/themes/dark.css" />
    <link rel="stylesheet" href="/style.css" />
    <!-- shoelace components -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/alert/alert.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/tooltip/tooltip.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/radio/radio.js"></script>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/icon-button/icon-button.js"
    ></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/icon/icon.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/dropdown/dropdown.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/menu/menu.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/menu-item/menu-item.js"></script>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/radio-group/radio-group.js"
    ></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/button/button.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/card/card.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/animation/animation.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/input/input.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/dialog/dialog.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/badge/badge.js"></script>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/tab-group/tab-group.js"
    ></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/tab/tab.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/tab-panel/tab-panel.js"></script>
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/components/progress-bar/progress-bar.js"
    ></script>
    <script src="vendor/ag-grid.js"></script>
    <script src="vendor/confetti.js"></script>
    <script src="vendor/papaparse.js"></script>
  </head>

  <style>
    #player::part(body) {
      display: none;
    }

    #tierlistDialog::part(body) {
      height: 100%;
      padding: 0;
    }

    #tierlistDialog sl-tab-panel::part(base) {
      padding: 0;
    }
    
    #tierlistDialog sl-tab-group {
      margin-top: 0;
    }

    /* Make the tabs only as tall as their content */
    #tierlistDialog sl-tab::part(base) {
      padding: var(--sl-spacing-2x-small) var(--sl-spacing-medium);
    }

    #tierlistDialog::part(header) {
      padding: 0; /* Remove padding to make it thinner */
      justify-content: flex-end; /* Push the content (the 'X' button) to the far right */
      border-bottom: none; /* Remove the line under the header */
    }

    #tierlistDialog::part(title) {
      display: none; /* Hide the title text */
    }

    #tierlistDialog::part(header-actions) {
      justify-content: flex-end; /* Push the 'X' button to the far right */
    }

    .sl-theme-dark sl-button[variant='neutral']::part(label) {
      color: white;
    }

    .sl-theme-dark .invert-in-dark-mode {
      filter: invert(1);
    }

    .control-button {
      --sl-spacing-x-small: 0; /* remove horizontal padding */
    }

    .control-button::part(base) {
      width: 3rem;
      height: 1rem;
      justify-content: center;
    }
  </style>

  <body>
    <div style="display: flex; flex-direction: column; height: 100%; padding: 1rem; overflow-x: auto; overflow-y: hidden">
      <!-- Top section with teams. flex-shrink: 0 prevents this container from shrinking when its content changes. -->
      <div id="teams-section-wrapper" style="width: 100%; display: flex; background-color: var(--container-bg-color); border: 1px solid black; padding: 0.2rem; flex-shrink: 0;">
        <div
          id="teamsSection"
          style="
            flex: 1;
            display: flex;
            justify-content: stretch;
            gap: 0.4rem;
            height: fit-content;
            min-height: fit-content;
            padding: 0.4rem;
            overflow-x: auto;
          "
        ></div>
      </div>
      <!-- center content container -->
      <div style="display: flex; justify-content: space-between; gap: 1rem; height: 100%; padding-top: 1rem">
        <!-- Left side section -->
        <div style="width: 75%; display: flex; flex-direction: column; gap: 1rem">
          <!-- Pokemon Info Section -->
          <div
            id="pokemon-info-section"
            style="height: 300px; background-color: var(--container-bg-color); border: 1px solid black; padding: 0.5rem; display: flex; justify-content: flex-start; align-items: stretch; gap: 0.05rem;"
          >
            <div id="species-info-text" style="display: none; flex: 0.6; text-align: left; overflow-y: auto; font-size: 0.9rem; margin: 0; padding-left: 2rem;"></div>
            <div id="pokemon-image-container" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 0.5rem;">
              <img id="pokemon-image" src="" alt="" style="display: none; max-height: 80%; max-width: 100%; object-fit: contain;" />
              <div id="pokemon-image-types" style="display: flex; gap: 0.2rem;"></div>
            </div>
            <div id="evolution-info-container" style="display: none; width: 450px; text-align: left; overflow: auto; font-size: 0.9rem; margin: 0; gap: 0.5rem; flex-direction: column; flex-shrink: 0;"></div>
          </div>
          <!-- Player list -->
          <div id="players-table-wrapper" style="height: 100%; width: 100%" class="ag-theme-balham"></div>
        </div>
        <!-- right side section with timer, current bid, player up for auction, etc -->
        <div id="right-panel" style="flex: 1; display: flex; flex-direction: column; gap: 1rem; height: 100%">
          <div
            style="
              flex: 5;
              flex-shrink: 0;
              position: relative;
              background-color: var(--container-bg-color);
              border: 1px solid black;
              padding: 4rem 0 1rem 0;
              display: flex;
              flex-direction: column;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div style="position: absolute; top: 0; width: 100%; padding: 1rem">
              <sl-progress-bar id="time" value="0" style="font-size: 0.9rem;"></sl-progress-bar>
            </div>

            <div id="player-card-container" style="display: flex; flex-direction: column; align-items: center; width: 100%">
              <div id="waiting-msg" style="padding: 0 1rem; text-wrap: wrap; font-size: large; text-align: center"></div>
              <sl-card id="player" hidden class="player-card" style="width: 90%; max-width: 25rem; min-height: 5rem"></sl-card>
            </div>

            <span id="ready-up-container" hidden>
              <sl-button id="ready-up" size="large" style="width: 6rem">
                <sl-animation name="flash" easing="ease-in-out" duration="2000" play>
                  <strong>Ready Up!</strong>
                </sl-animation>
              </sl-button>
            </span>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.2rem; text-align: center;">
              <div id="highest-bidder" style="max-width: 15rem; overflow: hidden; font-size: 0.9rem; color: var(--sl-color-neutral-600);"></div>
              <sl-animation id="current-bid-animation" name="tada" easing="linear" duration="1000" iterations="1">
                <div id="current-bid" class="current-bid" style="font-size: xx-large"></div>
              </sl-animation>
            </div>
            <div style="width: 100%; padding-left: 0.5rem; padding-right: 0.5rem">
              <div
                style="
                  display: flex;
                  width: 100%;
                  justify-content: center;
                  gap: 1rem;
                  border-radius: 0;
                  padding-top: 1rem;
                  padding-bottom: 1rem;
                  background-color: var(--container-bg-color);
                  align-items: center;
                "
              >
                <sl-button id="raise100" disabled value="100" class="bet fixed-bet" style="width: 5.5rem"> ▲ $100 </sl-button>
                <sl-input
                  id="raise-input"
                  type="number"
                  style="width: 7rem; box-shadow: var(--input-shadow-color) 0.15rem 0.15rem"
                  min="100"
                  step="100"
                  inputmode="decimal"
                ></sl-input>
                <sl-button id="raise" disabled class="bet"> Custom Bid </sl-button>
              </div>
            </div>
          </div>
          <div
            class="fade-bottom"
            style="
              position: relative;
              width: 100%;
              flex: 2;
              max-height: 10rem;
              overflow: hidden;
              border: 1px solid black;
              border-radius: 0;
              background-color: var(--container-bg-color);
            "
          >
            <div
              id="draft-log"
              style="
                display: flex;
                flex-direction: column;
                max-height: 9rem;
                padding: 0.4rem 0;
                gap: 0.5rem;
                width: 100%;
                font-family: 'Nimbus Mono PS', 'Courier New', monospace;
                line-height: 1em;
                overflow-y: scroll;
              "
            ></div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding-top: 0.5rem;">
            <div id="draft-counter" style="color: var(--sl-color-neutral-600);"></div>
            <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; width: 100%;">
              <sl-button id="tierlist-button" class="control-button" variant="neutral" title="View Tierlist">
                <img class="invert-in-dark-mode" src="/generic/TierIcon.png" alt="View Tierlist" style="height: 1.4rem; position: relative; top: 5px;" />
              </sl-button>
              <sl-button id="boss-battles-button" class="control-button" variant="neutral" title="View Boss Battles">
                <img class="invert-in-dark-mode" src="/generic/Sword.png" alt="View Boss Battles" style="height: 1.4rem; position: relative; top: 5px;" />
              </sl-button>
              <sl-button id="download-results-button" class="control-button" variant="neutral" title="Download Results">
                <img class="invert-in-dark-mode" src="/generic/Download.png" alt="Download Results" style="height: 1.4rem; position: relative; top: 5px;" />
              </sl-button>
              <sl-button id="dark-mode-toggle" class="control-button" variant="neutral"></sl-button>
              <sl-button id="pause-button" class="control-button" variant="neutral" title="Pause/Resume Timer">
                <sl-icon name="pause-fill" label="Pause" style="font-size: 1.4rem; position: relative; top: 5px;"></sl-icon>
              </sl-button>
            </div>
          </div>
          <!-- right side section -->
        </div>
      </div>
    </div>

    <sl-dialog id="teamSelectionDialog" label="Select Your Team" style="--width: 50vw">
      <div id="dialogContent" style="display: flex; gap: 1rem; flex-wrap: wrap"></div>
    </sl-dialog>

    <sl-dialog id="disconnectedDialog" label="Disconnected!">
      <div style="display: flex; justify-content: space-between">
        Reload the page to reconnect.
        <sl-button id="refreshButton" slot="footer" variant="primary">Reload</sl-button>
      </div>
    </sl-dialog>

    <sl-dialog id="noTeamsDialog" label="All Teams Connected!">
      <div style="display: flex; justify-content: space-between">
        All teams have already connected to this auction. If someone took your spot, call them and give them an earful.
        <sl-button id="refreshButton2" slot="footer" variant="primary">Reload</sl-button>
      </div>
    </sl-dialog>

    <sl-dialog id="bidConfirmationDialog" label="Confirm High Bid">
      <div id="bidConfirmationMessage"></div>
      <sl-button id="confirmBidButton" slot="footer" variant="primary">Confirm</sl-button>
      <sl-button id="cancelBidButton" slot="footer">Cancel</sl-button>
    </sl-dialog>

    <sl-dialog id="tierlistDialog" label="Tierlist" style="--width: 60vw; --height: 80vh;">
      <sl-tab-group>
        <sl-tab slot="nav" panel="full-game" active>Full Game Tiers</sl-tab>
        <sl-tab slot="nav" panel="gym-1-5">Gym 1-5 Tiers</sl-tab>

        <sl-tab-panel name="full-game" active style="height: 100%;">
          <img src="/tierlist.png" alt="Full Game Tierlist" style="width: 100%; height: 100%; object-fit: contain;" />
        </sl-tab-panel>
        <sl-tab-panel name="gym-1-5" style="height: 100%;">
          <img src="/earlytiers.png" alt="Gym 1-5 Tierlist" style="width: 100%; height: 100%; object-fit: contain;" />
        </sl-tab-panel>
      </sl-tab-group>
    </sl-dialog>

    <div id="flashbang-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.95); color: white; justify-content: center; align-items: center; z-index: 9999; font-size: 2rem; text-align: center;"></div>

    <!--
      define some reusable templates
    -->
    <template id="participant-template">
      <style>
        :host(.high-bidder) #main-content {
          /* Use box-shadow to create a thicker border effect without affecting layout size */
          border-color: black;
          box-shadow: 0 0 0 2px black;
        }
        .ready {
          background-color: var(--sl-color-green-200);
        }
        .waiting {
          background-color: var(--sl-color-amber-200);
        }
        .disconnected {
          color: gray;
          background-color: var(--sl-color-rose-200);
        }
        .done {
          background-color: var(--sl-color-sky-200);
        }
        #main-content {
          border-bottom: 3px solid var(--sl-color-neutral-400);
          border: 1px solid black;
        }
        :host-context(.sl-theme-dark) #main-content {
          border-bottom-color: black;
        }
      </style>
      <div style="position: relative">
        <div id="top-left" style="position: absolute; left: 0.2rem; top: 0.2rem; cursor: default; display: flex; gap: 0.2rem; align-items: center;">
            <slot name="top-left-action"></slot>
        </div>
        <div id="top-right" style="position: absolute; right: 0.2rem; top: 0.2rem; cursor: default">
          <slot name="top-right"></slot>
        </div>
        <div style="position: absolute; bottom: 0.3rem; left: 0.2rem; font-size: smaller; font-weight: bold; color: gray; cursor: default">
          <slot name="lower-left-content">
            <sl-tooltip content="Disconnected" hoist style="--sl-tooltip-arrow-size: 0"> D </sl-tooltip>
          </slot>
        </div>
        <div style="position: absolute; bottom: 0.3rem; right: 0.2rem; font-size: smaller; color: gray; cursor: default">
          <sl-tooltip content="Roster Count" hoist style="--sl-tooltip-arrow-size: 0">
            <slot name="lower-right-content"></slot>
          </sl-tooltip>
        </div>
        <div
          id="main-content"
          class="disconnected"
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            min-width: 5rem;
            height: 4rem;
            border-radius: 0;
          "
        >
          <div><slot name="participant-name"></slot></div>
          <div><slot name="remaining-funds"></slot></div>
        </div>
      </div>
    </template>
  </body>

  <script type="module">
    // module imports
    import { setBasePath } from 'https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/utilities/base-path.js';
    import { CountDownTimer } from '/clientModules/CountDownTimer.js';
    import { addPlayerIconToTeamCard } from '/clientModules/html.js';
    import { initTeamSelection } from '/clientModules/teamSelectionModal.js';
    import { setTimerTime, initBidButtonListeners, updateTeamCard, addMeIcon, toast } from '/clientModules/html.js';
    import { loadPlayersData, setupResourceModeKeyboardNav } from '/clientModules/playersTable.js';

    const SECONDS = 1000;
    const ctx = {
      ws: null, // websocket
      // type Team = {
      //   clientId: number;
      //   teamName: string;
      //   remainingFunds: number;
      //   connected: boolean;
      //   ready: boolean;  // team has selected they are ready to start the auction
      //   rosterCount: number;
      //   roster: Player[];
      // }
      // the actual teams map is injected into this HTML by the server, replacing the string replace target below
      teams: {}, // this is the target for a string replace server side
      allPlayersUnsorted: [], // A pristine, unsorted copy of all players for evolution lookups.
      playersTable: null,
      playersTableData: [],
      myClientId: undefined, // number
      stateId: 'pre_auction', // this is the target for a string replace server side
      isPaused: false,
      selectedPlayerId: null, // number
      currentBid: null, // number
      previousBid: null, // number
      lastBidUpdateTime: null, // number (timestamp)
      highestBidder: null, // number
      currentlySelectingTeam: null, // number
      timer: null, // CountDownTimer
      currentTimeLimit: null,
      biddingTimeLimit: null, // number
      totalPokemonAuctioned: 0,
      draftedPokemonCount: 0,
      maxRosterSize: null, // number   // this is the target for a string replace server side
      extraPlayerStatsFields: [], // holds IDs of extra fields that were added to the players data
      isResourceMode: false, // this is the target for a string replace server side
      flashbangsEnabled: false, // this is the target for a string replace server side
      // keep track of whether we have done the initial UI update when a player joins
      performedInitialUpdate: false,
    };

    ///////////
    // define the reusable web component templates from the above HTML
    ///////////
    customElements.define(
      'participant-el',
      class extends HTMLElement {
        constructor() {
          super();
          let participant = document.getElementById('participant-template');
          let myparticipant = participant.content;

          const shadowRoot = this.attachShadow({ mode: 'open' }).appendChild(myparticipant.cloneNode(true));
        }
      },
    );

    /**
     * Fetches and parses the speciesinfo.txt file.
     * The file is expected to have blocks of text for each Pokémon,
     * with the Pokémon's name on a line by itself.
     * @returns {Promise<Map<string, string>>} A map of Pokémon names to their info.
     */
    async function fetchAndParsePokemonInfo() {
      const speciesInfoMap = new Map(); // Will be Map<string, PokemonInfo>
      try {
        const response = await fetch('/api/speciesinfo');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        let text = await response.text();
        // Remove Byte Order Mark (BOM) if it exists, as it can interfere with parsing the first key.
        if (text.charCodeAt(0) === 0xfeff) {
          text = text.substring(1);
        }

        const lines = text.split(/\r\n?|\n/);
        let currentPokemonName = null;
        let currentInfo = {};
        let description = [];

        const saveCurrentPokemon = () => {
          if (currentPokemonName) {
            currentInfo.description = description.join('\n').trim();
            speciesInfoMap.set(currentPokemonName, currentInfo);
          }
        };

        for (const line of lines) {
          if (line.trim() === '') {
            saveCurrentPokemon();
            currentPokemonName = null;
            currentInfo = {};
            description = [];
            continue;
          }

          if (!currentPokemonName) {
            currentPokemonName = line.trim();
            continue;
          }

          const parts = line.split(':');
          if (parts.length > 1) {
            const key = parts[0].trim().toLowerCase();
            const value = parts.slice(1).join(':').trim();
            // All key:value pairs are now just part of the description.
            description.push(line);
          } else {
            description.push(line);
          }
        }
        saveCurrentPokemon(); // Save the last Pokémon in the file
      } catch (e) {
        console.error('Failed to load or parse speciesinfo.txt:', e);
      }
      return speciesInfoMap;
    }

    /**
     * Populates the drafted player icons on each team card based on the initial data.
     * This is necessary for clients who join or refresh mid-auction.
     */
    function populateInitialDraftIcons(ctx) {
      console.log('[Init] Populating initial draft icons for all teams.');
      for (const team of Object.values(ctx.teams)) {
        if (team.roster && Array.isArray(team.roster)) {
          console.log(`[Init] Found ${team.roster.length} players for team ${team.teamName}.`);
          team.roster.forEach((player) => addPlayerIconToTeamCard(team.clientId, player.name));
        }
      }
    }

    async function main() {
      setBasePath('https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/');

      // --- Helper Functions ---
      const get = (id) => document.getElementById(id);

      // --- Dark Mode Logic ---
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      const htmlEl = document.documentElement;

      function applyTheme(theme) {
        const tableWrapper = document.getElementById('players-table-wrapper');
        if (theme === 'dark') {
          htmlEl.classList.add('sl-theme-dark');
          if (tableWrapper) {
            tableWrapper.classList.add('ag-theme-balham-dark');
          }
          darkModeToggle.innerHTML = '<img src="/MiniIcons/solrock.png" alt="Light Mode" style="height: 1.4rem; position: relative; top: 6px;">';
        } else {
          htmlEl.classList.remove('sl-theme-dark');
          if (tableWrapper) {
            tableWrapper.classList.remove('ag-theme-balham-dark');
          }
          darkModeToggle.innerHTML = '<img src="/MiniIcons/lunatone.png" alt="Dark Mode" style="height: 1.4rem; position: relative; top: 6px;">';
        }
      }

      // Check for saved theme in localStorage on page load
      const savedTheme = localStorage.getItem('theme') || 'light';
      applyTheme(savedTheme);

      // Add event listener to the toggle button
      darkModeToggle.addEventListener('click', () => {
        const newTheme = htmlEl.classList.contains('sl-theme-dark') ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
      });
      // --- End Dark Mode Logic ---

      ctx.timer = new CountDownTimer();
      // set the timer to update the UI on each "tick"
      ctx.timer.onTick((remaining, parsed, displayDuration) => {
        setTimerTime(
          `${String(parsed.minutes).padStart(2, '0')}:${String(parsed.seconds).padStart(2, '0')}`,
          remaining,
          displayDuration,
        );
      });

      // stop the "flash-of-undefined-components" by waiting until all components are registered.
      await Promise.allSettled([
        customElements.whenDefined('sl-button'),
        customElements.whenDefined('sl-dialog'),
        customElements.whenDefined('sl-radio'),
        customElements.whenDefined('sl-radio-group'),
        customElements.whenDefined('sl-progress-bar'),
        customElements.whenDefined('sl-icon'),
      ]);

      // Add the `ready` class so the UI fades in.
      document.body.classList.add('ready');
      // Add listener for 'Enter' key on the custom bid input
      const raiseInput = document.getElementById('raise-input');
      const raiseButton = document.getElementById('raise');
      raiseInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault(); // prevent any default form submission
          raiseButton.click(); // trigger the custom bid button's click event
        }
      });

      // If there are no teams, we can assume we are in resource mode.
      // This is a fallback in case the server-side injection of `isResourceMode` fails.
      if (Object.keys(ctx.teams).length === 0) {
        ctx.isResourceMode = true;
      }

      // Load all necessary data (like the playerMap) before initializing UI that depends on it.
      ctx.speciesInfoMap = await fetchAndParsePokemonInfo();
      await loadPlayersData(ctx);

      // If in resource mode, hide irrelevant UI and skip websocket/team setup.
      if (ctx.isResourceMode) {
        document.getElementById('teams-section-wrapper').style.display = 'none';
        document.getElementById('right-panel').style.display = 'none';
        document.querySelector('div[style*="width: 75%; display: flex;"]').style.width = '100%'; // Make player list full width
        setupResourceModeKeyboardNav(ctx);
        return; // End script execution here for resource mode
      }

      // Now that data is loaded, initialize the interactive components like the team selection dialog.
      initTeamSelection(ctx);
      initBidButtonListeners(ctx);

      // Populate icons for players who were already drafted before this client joined.
      populateInitialDraftIcons(ctx);

      document.getElementById('refreshButton').addEventListener('click', (e) => location.reload());
      document.getElementById('refreshButton2').addEventListener('click', (e) => location.reload());

      // Pause button listener
      const pauseButton = document.getElementById('pause-button');
      pauseButton.addEventListener('click', () => {
        if (ctx.ws) {
          ctx.ws.send(JSON.stringify({ type: 'toggle_pause', stateId: ctx.stateId }));
        }
      });

      // Download results button listener
      const downloadButton = document.getElementById('download-results-button');
      downloadButton.addEventListener('click', () => {
        const draftedPlayers = ctx.playersTableData.filter((p) => p.pickedBy);

        if (draftedPlayers.length === 0) {
          toast('Info', 'No players have been drafted yet.', 'primary');
          return;
        }

        const csvData = draftedPlayers.map((p) => ({
          Player: p.name,
          'Drafted By': p.pickedBy,
          Cost: p.cost,
        }));

        const csvString = Papa.unparse(csvData);

        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'draft-results.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      // Tierlist button listener
      const tierlistButton = document.getElementById('tierlist-button');
      const tierlistDialog = document.getElementById('tierlistDialog');

      tierlistButton.addEventListener('click', () => {
        tierlistDialog.show();
      });

      // The dialog can be closed by pressing Escape, clicking the close button in the header, or by clicking the overlay.
      // Shoelace dialogs have a close button by default in the header.
      // We can also add a listener to hide it if needed for other interactions.

      // Boss Battles button listener
      const bossBattlesButton = document.getElementById('boss-battles-button');
      bossBattlesButton.addEventListener('click', () => {
        window.open('/assets/boss-battles.html', '_blank');
      });
    }

    main();
  </script>
</html>
